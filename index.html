<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width"
    />
    <title>Halloween AR</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-event-set-component@5.x.x/dist/aframe-event-set-component.min.js"></script>
  </head>
  <body>
    <a-scene>
      <a-assets>
        <a-asset-item id="doll" src="doll/scene.gltf"></a-asset-item>
        <a-asset-item id="girl" src="girl/scene.gltf"></a-asset-item>
        <a-asset-item id="skull" src="skull/scene.gltf"></a-asset-item>
       
    
        <img id="background" src="./background.jpg">
      
        
        <video
          id="doll_video"
          autoplay
          loop
          muted
          playsinline
          crossorigin="anonymous"
          preload="auto"
          src="./doll_video.mp4"
        ></video>
        <video
          id="girl_video"
          autoplay
          loop
          muted
          playsinline
          crossorigin="anonymous"
          preload="auto"
          src="./girl.mp4"
        ></video>
         <video
          id="skull_video"
          autoplay
          loop
          muted
          playsinline
          crossorigin="anonymous"
          preload="auto"
          src="./skull.mp4"
        ></video>
      </a-assets>

      <a-sky src="#background" rotation="0 -90 0" material="shader: flat;" raycaster="objects: .clickable"></a-sky>

      

      <!-- Loading Spinner -->
      <a-entity id="loadingSpinner" position="0 1.5 -3" visible="false">
        <a-ring color="yellow" radius-inner="0.1" radius-outer="0.15" rotation="0 0 90">
          <a-animation attribute="rotation" dur="2000" to="0 0 -360" easing="linear" repeat="indefinite"></a-animation>
        </a-ring>
        <a-text value="Loading Model..." position="0 -0.2 0" align="center" color="white" scale="0.5 0.5 0.5"></a-text>
      </a-entity>

      <!-- Doll -->
      <a-entity position="0 0 -5">
        <a-cylinder
          id="triggerCylinder"
          class="clickable"
          position="0 -2 -10"
          radius="4"
          height="0.5"
          color="#808080"
        >

          
            <a-video
              src="#doll_video"
              width="18"
              height="28"
              position="0 12 -4"
              material="shader: flat; side: double; transparent: true"
            ></a-video>
          </a-text>
        </a-cylinder>

        <!-- Rotating model -->
        <a-entity position="0 -1.5 -8">
          <a-entity
            cursor="rayOrigin: mouse"
            animation="property: rotation; to: 0 360 0; loop: true; dur: 8000; easing: linear"
            gltf-model="#doll"
            position="0 4 2.5"
            scale="3.5 3.5 3.5"
          ></a-entity>
        </a-entity>
      </a-entity>

      <!-- GIRL SECTION -->
      <a-entity position="15 0 -5">
        <a-cylinder
          id="triggerCylinder2"
          class="clickable"
          position="-3 -2 5"
          radius="4"
          height="0.5"
          color="#808080"
        >
        
            <a-video
              src="#girl_video"
              width="16"
              height="24"
              position="4 10 0"
              material="shader: flat; side: double; transparent: true"
              rotation="0 -90 0"
            ></a-video>
          </a-text>
        </a-cylinder>

        <!-- Girl model -->
        <a-entity position="0 0.5 0">
          <a-entity
            cursor="rayOrigin: mouse"
            animation="property: rotation; to: 0 360 0; loop: true; dur: 8000; easing: linear"
            gltf-model="#girl"
            position="-5 1 5"
            scale="3 3 3"
          ></a-entity>
        </a-entity>
      </a-entity>

      <!-- LEFT SECTION -->
      <a-entity position="-7 0 -7">
        <a-cylinder
          id="triggerCylinder3"
          class="clickable"
          position="-5 -2 8"
          radius="4"
          height="0.5"
          color="#808080"
        >
            <a-video
              src="#skull_video"
              width="16"
              height="24"
              position="-5 10 0"
              material="shader: flat; side: double; transparent: true"
              rotation="0 90 0"
            ></a-video>
          </a-text>
        </a-cylinder>

        <!-- Skull model -->
        <a-entity position="0 0.5 0">
          <a-entity
            id="leftSkullModel"
            class="clickable"
            cursor="rayOrigin: mouse"
            animation="property: rotation; to: 0 360 0; loop: true; dur: 8000; easing: linear"
            gltf-model="#skull"
            position="-5 -0.5 8"
            scale="8 8 8"
          ></a-entity>
        </a-entity>
      </a-entity>

      <!-- Camera with cursor -->
      <a-camera>
        <a-cursor
        material="color: #FFFFFF; opacity: 0; transparent: true">
        </a-cursor>
      </a-camera>
    </a-scene>

    <script>
      // Preload models to prevent loading delays
      function preloadModels() {
        const models = ['#doll', '#girl', '#skull'];
        models.forEach(model => {
          const el = document.createElement('a-entity');
          el.setAttribute('gltf-model', model);
          el.setAttribute('visible', 'false');
          document.querySelector('a-scene').appendChild(el);
          setTimeout(() => {
            document.querySelector('a-scene').removeChild(el);
          }, 1000);
        });
      }

      // link
      function setupImageLinks() {
        const links = [
          { id: 'gtrLink', url: 'https://www.nissan.ph/vehicles/new/GT-R.html' },
          { id: 'porscheLink', url: 'https://www.porsche.com/usa/models/911/911-gt3-rs/911-gt3-rs/' },
        ];

        links.forEach(link => {
          const element = document.querySelector(`#${link.id}`);
          if (element) {
            element.addEventListener('click', function () {
              window.location.href = link.url;
            });
          }
        });
      }



      // Debounce function to prevent rapid clicks
      function debounce(func, wait) {
        let timeout;
        return function() {
          const context = this;
          const args = arguments;
          clearTimeout(timeout);
          timeout = setTimeout(() => {
            func.apply(context, args);
          }, wait);
        };
      }

      window.addEventListener('DOMContentLoaded', function() {
        // Preload models when page loads
        preloadModels();
        setupImageLinks();
        

        
        const dollVideo = document.querySelector("#doll_video");
        const girlVideo = document.querySelector("#girl_video");
        const skullVideo = document.querySelector("#skull_video");
    
        // Improved video handling
        function handleVideo(video) {
          if (video.readyState >= 3) { // HAVE_FUTURE_DATA
            video.play().catch((e) => {
              console.error("Auto-play failed:", e);
              // Fallback: Play on user interaction
              document.addEventListener(
                "click",
                function playVideo() {
                  video.play();
                  document.removeEventListener("click", playVideo);
                },
                { once: true }
              );
            });
          }
        }

        // Event listeners for videos
        [skullVideo, dollVideo, girlVideo].forEach(video => {
          video.addEventListener("loadedmetadata", () => handleVideo(video));
          video.addEventListener("canplay", () => handleVideo(video));
          video.addEventListener("error", function () {
            console.error("Video error:", video.error);
          });
        });

        // Fallback: Try to play after a short delay
        setTimeout(() => {
          handleVideo(dollVideo);
          handleVideo(girlVideo);
          handleVideo(skullVideo);
        }, 1000);

        // Click handler component
        AFRAME.registerComponent("click-handler", {
          init: function () {
            this.el.addEventListener("mouseenter", () => {
              console.log("Hover detected on:", this.el);
            });

            this.el.addEventListener("click", (evt) => {
              console.log("Click event detected on:", this.el);
              const url = this.el.getAttribute("data-url");
              if (url) {
                window.open(url, "_blank");
              }
            });
          },
        });
      });
    </script>
  </body>
</html>
